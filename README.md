# egg-apigw-tracer

[![npm version](https://img.shields.io/npm/v/egg-apigw-tracer)](https://www.npmjs.com/package/egg-apigw-tracer) [![MIT](https://img.shields.io/npm/l/egg-apigw-tracer)](https://github.com/inlym/egg-apigw-tracer/blob/master/LICENSE) [![npm](https://img.shields.io/npm/dw/egg-apigw-tracer)](https://www.npmjs.com/package/egg-apigw-tracer) [![star](https://gitee.com/inlym/egg-apigw-tracer/badge/star.svg?theme=dark)](https://gitee.com/inlym/egg-apigw-tracer/stargazers)

![egg-apigw-tracer-image](https://img.inlym.com/dca8bebe5e534bfa87b52f42e7be282c.png)

é€‚é… API ç½‘å…³çš„ HTTP è¯·æ±‚ç¤ºè¸ªå™¨ï¼Œç”¨äº Egg.js æ¡†æ¶ã€‚

## ç›®å½•

- [egg-apigw-tracer](#egg-apigw-tracer)
  - [ç›®å½•](#ç›®å½•)
  - [ä»‹ç»](#ä»‹ç»)
  - [å®‰è£…](#å®‰è£…)
  - [ä½¿ç”¨](#ä½¿ç”¨)
    - [å¯ç”¨æ’ä»¶](#å¯ç”¨æ’ä»¶)
    - [é…ç½®æ–¹å¼](#é…ç½®æ–¹å¼)
    - [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)
  - [ç¤ºä¾‹](#ç¤ºä¾‹)
  - [ç›¸å…³](#ç›¸å…³)
  - [ä½œè€…](#ä½œè€…)
  - [å‚ä¸](#å‚ä¸)
  - [è®¸å¯è¯](#è®¸å¯è¯)

## ä»‹ç»

åœ¨å¯¹å¤–æä¾› Web æœåŠ¡æ—¶ï¼Œå¯èƒ½åœ¨çº¿ä¸Šç¯å¢ƒå‡ºç°å¶å‘æ€§çš„é”™è¯¯ï¼Œä¸ºäº†æ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼Œç»™æ‰€æœ‰çš„è¯·æ±‚éƒ½æä¾›ä¸€ä¸ª **å”¯ä¸€è¯·æ±‚ ID** æ˜¯ä¸€ä¸ªä¸é”™çš„å®è·µï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®è¿™ä¸ªè¯·æ±‚ ID å»ç›¸å…³æ—¥å¿—ä¸­æ‰¾å¯»å¯¹åº”çš„é”™è¯¯å†…å®¹ã€‚

è¿™ä¸ªã€Œå”¯ä¸€è¯·æ±‚ IDã€ï¼ˆUnique Request IDï¼‰æœ‰çš„æ—¶å€™ä¹Ÿå«ã€Œç¤ºè¸ª IDã€ï¼ˆtrace IDï¼‰ï¼Œä¸€ä¸ªé€šä¿—çš„åšæ³•æ˜¯ä½¿ç”¨ UUID ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨å“åº”ä¸­é™„å¸¦è¯¥å­—ç¬¦ä¸²ã€‚å¦å¤–ä¸€äº› Web æœåŠ¡ï¼Œä¼šä½¿ç”¨äº‘å‚å•†çš„ API ç½‘å…³ä½œä¸ºæ¥å…¥å±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘åˆ°å¼€å‘è€…è‡ªå·±çš„æœåŠ¡å™¨ä¸Šã€‚æ­¤æ—¶æˆ‘ä»¬å¾€å¾€å¸Œæœ›ä½¿ç”¨ API ç½‘å…³è‡ªå¸¦çš„è¯·æ±‚ ID ä½œä¸ºç¤ºè¸ª IDï¼Œæœ¬æ’ä»¶å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è¯ç”Ÿçš„ã€‚

æœ¬æ’ä»¶å®Œç¾é€‚é… **Egg.js** æ¡†æ¶ï¼Œåªéœ€è¦æŒ‰ç…§æ¡†æ¶è¦æ±‚å¯ç”¨æ’ä»¶ï¼Œå¯ä»¥**é›¶é…ç½®**ä½¿ç”¨ã€‚

## å®‰è£…

æŒ‰ç…§é€šç”¨çš„æ–¹å¼ä½¿ç”¨ npm ä¸‹è½½å®‰è£…åˆ°ä½ çš„é¡¹ç›®ä¸‹å³å¯ï¼Œæ— éœ€å…¨å±€å®‰è£…ã€‚

å®‰è£…å‘½ä»¤ï¼š

```shell
npm i egg-apigw-tracer
```

## ä½¿ç”¨

åœ¨ä½¿ç”¨å‰ï¼Œè¯·ç¡®ä¿ä½ å·²ç»é˜…è¯» Egg.js æ¡†æ¶å…³äº**æ’ä»¶**çš„ [æ–‡æ¡£](https://eggjs.org/zh-cn/basics/plugin.html) ã€‚

ä¸‹é¢è¯´æ˜å¦‚ä½•é…ç½®ä»¥åŠä½¿ç”¨æ’ä»¶ã€‚

### å¯ç”¨æ’ä»¶

åœ¨ `config/plugin.js` æ–‡ä»¶ä¸­ä¸­å£°æ˜å¯ç”¨æ’ä»¶ï¼š

```js
exports.tracer = {
  /** æ˜¯å¦å¯ç”¨æ’ä»¶ï¼Œtrue ä¸ºå¯ç”¨ï¼Œfalse ä¸ºç¦ç”¨ */
  enable: true,

  /** æŒ‡å®šæ’ä»¶ä½¿ç”¨çš„åŒ…ï¼Œä¸º 'egg-apigw-tracer' */
  package: 'egg-apigw-tracer',
}
```

### é…ç½®æ–¹å¼

æœ¬æ’ä»¶æ— éœ€ä»»ä½•é…ç½®å³å¯ä½¿ç”¨ã€‚ä½†è€ƒè™‘åˆ°ä»¥ä¸‹ä½¿ç”¨åœºæ™¯ï¼š

> çº¿ä¸Šç”Ÿäº§ç¯å¢ƒä½¿ç”¨ API ç½‘å…³åšæ¥å…¥å±‚ï¼Œä½¿ç”¨ API ç½‘å…³è‡ªå¸¦çš„è¯·æ±‚ ID åšç¤ºè¸ª IDï¼Œä½†æœ¬åœ°å¼€å‘ç¯å¢ƒæ— è¯¥æ¥å…¥å±‚ï¼ŒåŒæ—¶ä¸ºäº†ä¿æŒåŠŸèƒ½é€»è¾‘ä¸€è‡´ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ªç±»ä¼¼çš„ç¤ºè¸ª IDï¼Œå› æ­¤ä½¿ç”¨ UUID åšç¤ºè¸ª IDã€‚

åœ¨ `config/config.${env}.js` æ–‡ä»¶é…ç½®æ’ä»¶çš„ä½¿ç”¨æ–¹å¼ï¼ˆä»¥ä¸‹ä¸ºé»˜è®¤é…ç½®ï¼‰ï¼š

```js
exports.tracer = {
  mode: 'apigw',
  idHeader: 'x-ca-request-id',
}
```

å„é…ç½®é¡¹çš„å«ä¹‰æ˜¯ï¼š

|   å±æ€§   |  ç±»å‹  |      é»˜è®¤å€¼       | æ˜¯å¦å¿…å¡« |                                        è¯´æ˜                                        |
| :------: | :----: | :---------------: | :------: | :--------------------------------------------------------------------------------: |
|   mode   | string |      'apigw'      |    å¦    | æ¨¡å¼ï¼Œä½¿ç”¨ `apigw` è¡¨ç¤ºå­˜åœ¨ API ç½‘å…³æ¥å…¥å±‚ï¼Œä½¿ç”¨ `uuid` è¡¨ç¤ºä½¿ç”¨ uuid ç”Ÿæˆç¤ºè¸ª ID  |
| idHeader | string | 'x-ca-request-id' |    å¦    | ä»…åœ¨ä½¿ç”¨`apigw` æ¨¡å¼ä¸‹è¯¥è®¾ç½®é¡¹æœ‰æ•ˆï¼Œè¡¨æ˜ä»æŒ‡å®šçš„è¯·æ±‚å¤´ä¸­è·å–`requestId`ç”¨ä½œç¤ºè¸ª ID |

### ä½¿ç”¨è¯´æ˜

ä¸»è¦æœ‰ 2 å¤„ä½¿ç”¨åœºæ™¯ï¼Œä¸€æ˜¯ä½ å¯ä»¥ç›´æ¥é€šè¿‡ `ctx.traceId` è·å–ç¤ºè¸ª IDï¼ŒäºŒæ˜¯ä½ ä½¿ç”¨ `ctx.logger` æ‰“å°æ—¥å¿—æ—¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨åœ¨æ—¥å¿—å‰é™„ä¸Šç¤ºè¸ª IDï¼Œå‰ç¼€æ ¼å¼ä¸ºï¼š`[$userId/$ip/$traceId/${cost}ms $method $url]` ï¼Œè¯¦æƒ…è§ [æ–‡æ¡£](https://eggjs.org/zh-cn/core/logger.html#å¦‚ä½•æ‰“å°æ—¥å¿—) ã€‚

## ç¤ºä¾‹

æˆ‘ä»¬æ¨¡æ‹Ÿä»¥ä¸‹è¿™ä¸ªä½¿ç”¨åœºæ™¯ï¼Œæ¥æ¼”ç¤ºå¦‚ä½•é…ç½®å’Œä½¿ç”¨æœ¬æ’ä»¶ï¼š

> çº¿ä¸Šç”Ÿäº§ç¯å¢ƒä½¿ç”¨ [é˜¿é‡Œäº‘](https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=lzfqdh6g) API ç½‘å…³åšæ¥å…¥å±‚ï¼Œæœ¬åœ°å¼€å‘æµ‹è¯•æœªä½¿ç”¨ç‰¹å®šæ¥å…¥å±‚ã€‚

åœ¨ `config/plugin.js` æ–‡ä»¶ä¸­ä¸­å£°æ˜å¯ç”¨æ’ä»¶ï¼š

```js
exports.tracer = {
  enable: true,
  package: 'egg-apigw-tracer',
}
```

åœ¨ `config.local.js` æ–‡ä»¶ä¸­é…ç½®å†…å®¹ä¸ºï¼š

```js
exports.tracer = {
  mode: 'uuid',
}
```

åœ¨ `config.prod.js` æ–‡ä»¶ä¸­é…ç½®å†…å®¹ä¸ºï¼š

```js
exports.tracer = {
  mode: 'apigw',
}
```

## ç›¸å…³

ä»¥ä¸‹æ˜¯ä½œè€…å¼€å‘çš„ Egg.js æ¡†æ¶çš„æ’ä»¶ç³»åˆ—ï¼Œå·²ç”¨äºä½œè€…çš„ç”Ÿäº§é¡¹ç›®ä¸­ï¼Œæ¨èä½¿ç”¨ã€‚

- [egg-apigw-tracer](https://github.com/inlym/egg-apigw-tracer) - âš¡ é€‚é… API ç½‘å…³çš„ HTTP è¯·æ±‚ç¤ºè¸ªå™¨ï¼Œç”¨äº Egg.js æ¡†æ¶
- [egg-aliyun-tablestore](https://github.com/inlym/egg-aliyun-tablestore) - ğŸšš é˜¿é‡Œäº‘è¡¨æ ¼å­˜å‚¨ï¼ˆTablestoreï¼‰æ’ä»¶ï¼Œç”¨äº Egg.js æ¡†æ¶
- [egg-load](https://github.com/inlym/egg-load) - ğŸš€ è‡ªåŠ¨æŒ‚è½½ç¬¬ä¸‰æ–¹æ¨¡å—è‡³ Egg.js æ¡†æ¶ä¸Š

## ä½œè€…

æˆ‘æ˜¯ [inlym](https://www.inlym.com) ï¼Œä¸€ä¸ªäº§å“ç»ç†å’Œå…¨æ ˆå¼€å‘è€…ã€‚

å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–è€…å»ºè®®ï¼Œæ¬¢è¿è”ç³»æˆ‘ï¼Œä»¥ä¸‹æ˜¯æˆ‘çš„è”ç³»æ–¹å¼ï¼š

- é‚®ç®±ï¼šinlym@qq.com
- ä¸»é¡µï¼š[www.inlym.com](https://www.inlym.com)

## å‚ä¸

éå¸¸æ¬¢è¿ä½ èƒ½å¤Ÿå‚ä¸è¿™ä¸ªé¡¹ç›®çš„å¼€å‘å’Œç»´æŠ¤ã€‚

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å‚ä¸åˆ°é¡¹ç›®ä¸­ï¼š

1.  æå»ºè®®å’Œéœ€æ±‚ã€‚å¯¹äºå‡ å¥è¯å°±èƒ½è¯´æ¸…æ¥šçš„å»ºè®®å’Œéœ€æ±‚ï¼Œä½ å¯ä»¥ç›´æ¥ æä¸€ä¸ª [New Issue](https://github.com/inlym/egg-apigw-tracer/issues/new) ã€‚
2.  Fork é¡¹ç›®ï¼Œä¿®æ”¹ä»£ç ï¼Œç„¶åæäº¤ Pull requests ã€‚ï¼ˆæäº¤å‰è¯·æ£€æŸ¥åŠ¡å¿…é€šè¿‡ ESLint æ£€æŸ¥ï¼‰

## è®¸å¯è¯

æœ¬æ’ä»¶ä½¿ç”¨ [MIT](LICENSE) è®¸å¯è¯ã€‚
